{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///Users/gabrieldesouza/Documents/trae_projects/flow4network/src/lib/auth.ts"],"sourcesContent":["import jwt from 'jsonwebtoken';\nimport bcrypt from 'bcryptjs';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'super-secret-key-change-this';\n\nexport interface TokenPayload {\n  userId: string;\n  role: string;\n  username: string;\n}\n\nexport function signToken(payload: TokenPayload, expiresIn: string | number = '8h'): string {\n  return jwt.sign(payload, JWT_SECRET, { expiresIn: expiresIn as any });\n}\n\nexport function verifyToken(token: string): TokenPayload | null {\n  try {\n    return jwt.verify(token, JWT_SECRET) as TokenPayload;\n  } catch (error) {\n    return null;\n  }\n}\n\nexport async function hashPassword(password: string): Promise<string> {\n  return await bcrypt.hash(password, 10);\n}\n\nexport async function comparePassword(password: string, hash: string): Promise<boolean> {\n  return await bcrypt.compare(password, hash);\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAQtC,SAAS,UAAU,OAAqB,EAAE,YAA6B,IAAI;IAChF,OAAO,gMAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE,WAAW;IAAiB;AACrE;AAEO,SAAS,YAAY,KAAa;IACvC,IAAI;QACF,OAAO,gMAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAEO,eAAe,aAAa,QAAgB;IACjD,OAAO,MAAM,4LAAM,CAAC,IAAI,CAAC,UAAU;AACrC;AAEO,eAAe,gBAAgB,QAAgB,EAAE,IAAY;IAClE,OAAO,MAAM,4LAAM,CAAC,OAAO,CAAC,UAAU;AACxC"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///Users/gabrieldesouza/Documents/trae_projects/flow4network/src/lib/audit.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\n\nexport async function logAudit(\n  userId: string | null,\n  action: string,\n  status: 'SUCCESS' | 'FAILURE',\n  req: Request,\n  details?: any\n) {\n  const ip = req.headers.get('x-forwarded-for') || 'unknown';\n  const userAgent = req.headers.get('user-agent') || 'unknown';\n\n  try {\n    await prisma.auditLog.create({\n      data: {\n        userId,\n        action,\n        status,\n        ip,\n        userAgent,\n        details: details ? JSON.stringify(details) : undefined,\n      },\n    });\n  } catch (error) {\n    console.error('Failed to create audit log:', error);\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,SAAS,IAAI,oPAAY;AAExB,eAAe,SACpB,MAAqB,EACrB,MAAc,EACd,MAA6B,EAC7B,GAAY,EACZ,OAAa;IAEb,MAAM,KAAK,IAAI,OAAO,CAAC,GAAG,CAAC,sBAAsB;IACjD,MAAM,YAAY,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB;IAEnD,IAAI;QACF,MAAM,OAAO,QAAQ,CAAC,MAAM,CAAC;YAC3B,MAAM;gBACJ;gBACA;gBACA;gBACA;gBACA;gBACA,SAAS,UAAU,KAAK,SAAS,CAAC,WAAW;YAC/C;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;IAC/C;AACF"}},
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///Users/gabrieldesouza/Documents/trae_projects/flow4network/src/app/api/auth/login/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { PrismaClient } from '@prisma/client';\nimport { z } from 'zod';\nimport { signToken, comparePassword } from '@/lib/auth';\nimport { logAudit } from '@/lib/audit';\n\nconst prisma = new PrismaClient();\n\nconst loginSchema = z.object({\n  username: z.string().min(1, 'Username is required'),\n  password: z.string().min(1, 'Password is required'),\n  remember: z.boolean().optional(),\n});\n\nconst MAX_FAILED_ATTEMPTS = 5;\nconst LOCKOUT_DURATION_MS = 15 * 60 * 1000; // 15 minutes\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const validation = loginSchema.safeParse(body);\n\n    if (!validation.success) {\n      return NextResponse.json({ error: validation.error.issues[0].message }, { status: 400 });\n    }\n\n    const { username, password, remember } = validation.data;\n\n    const user = await prisma.user.findFirst({\n      where: { \n        OR: [\n            { username },\n            { email: username }\n        ]\n      },\n    });\n\n    if (!user) {\n      // Fake delay to prevent timing attacks\n      await new Promise(resolve => setTimeout(resolve, 500));\n      await logAudit(null, 'LOGIN', 'FAILURE', request, { username, reason: 'User not found' });\n      return NextResponse.json({ error: 'Credenciais inválidas' }, { status: 401 });\n    }\n\n    // Check Lockout\n    if (user.lockoutUntil && user.lockoutUntil > new Date()) {\n        await logAudit(user.id, 'LOGIN', 'FAILURE', request, { reason: 'Account locked' });\n        const minutesLeft = Math.ceil((user.lockoutUntil.getTime() - Date.now()) / 60000);\n        return NextResponse.json({ error: `Conta bloqueada. Tente novamente em ${minutesLeft} minutos.` }, { status: 429 });\n    }\n\n    const isValid = await comparePassword(password, user.password);\n\n    if (!isValid) {\n        const failedAttempts = user.failedLoginAttempts + 1;\n        let lockoutUntil = user.lockoutUntil;\n\n        if (failedAttempts >= MAX_FAILED_ATTEMPTS) {\n            lockoutUntil = new Date(Date.now() + LOCKOUT_DURATION_MS);\n        }\n\n        await prisma.user.update({\n            where: { id: user.id },\n            data: { failedLoginAttempts: failedAttempts, lockoutUntil }\n        });\n\n        await logAudit(user.id, 'LOGIN', 'FAILURE', request, { reason: 'Invalid password', attempt: failedAttempts });\n        return NextResponse.json({ error: 'Credenciais inválidas' }, { status: 401 });\n    }\n\n    // Login Success\n    await prisma.user.update({\n        where: { id: user.id },\n        data: { failedLoginAttempts: 0, lockoutUntil: null }\n    });\n\n    // Token Expiration\n    const expiresIn = remember ? '30d' : '8h';\n    const token = signToken({\n        userId: user.id,\n        role: user.role,\n        username: user.username || user.email\n    }, expiresIn);\n\n    await logAudit(user.id, 'LOGIN', 'SUCCESS', request);\n\n    const response = NextResponse.json({ \n        success: true, \n        user: {\n            id: user.id,\n            name: user.name,\n            email: user.email,\n            role: user.role,\n            mustChangePassword: user.mustChangePassword\n        }\n    });\n\n    // Set Cookie\n    const maxAge = remember ? 60 * 60 * 24 * 30 : 60 * 60 * 8; // 30 days or 8 hours\n\n    response.cookies.set('token', token, {\n        httpOnly: true,\n        secure: process.env.NODE_ENV === 'production',\n        sameSite: 'strict',\n        maxAge: maxAge, \n        path: '/'\n    });\n\n    return response;\n\n  } catch (error) {\n    console.error('Login error:', error);\n    return NextResponse.json({ error: 'Erro interno no servidor' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}